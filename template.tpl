___TERMS_OF_SERVICE___

By creating or modifying this file you agree to Google Tag Manager's Community
Template Gallery Developer Terms of Service available at
https://developers.google.com/tag-manager/gallery-tos (or such other URL as
Google may provide), as modified from time to time.


___INFO___

{
  "type": "TAG",
  "id": "cvt_temp_public_id",
  "version": 1,
  "securityGroups": [],
  "categories": [
    "AFFILIATE_MARKETING",
    "ADVERTISING"
  ],
  "displayName": "Effinity",
  "brand": {
    "id": "brand_dummy",
    "displayName": "Addingwell",
    "thumbnail": "data:image/png;base64,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\u003d\u003d"
  },
  "description": "Tag to implement server-side cookie for Effinity and setup concurrent tracking with server to server (S2S).",
  "containerContexts": [
    "SERVER"
  ]
}


___TEMPLATE_PARAMETERS___

[
  {
    "type": "TEXT",
    "name": "customerId",
    "displayName": "Effinity Id",
    "simpleValueType": true,
    "valueValidators": [
      {
        "type": "NON_EMPTY"
      }
    ],
    "help": "Your unique identifier on Effinity",
    "alwaysInSummary": true
  },
  {
    "type": "CHECKBOX",
    "name": "clearCookie",
    "checkboxText": "Clear Effinity cookie when receiving a purchase",
    "simpleValueType": true
  },
  {
    "type": "GROUP",
    "name": "standardParameters",
    "displayName": "Overwrite Standard Parameters",
    "groupStyle": "ZIPPY_CLOSED",
    "subParams": [
      {
        "type": "LABEL",
        "name": "label1",
        "displayName": "By default, it uses GA4 ecommerce fields"
      },
      {
        "type": "TEXT",
        "name": "transactionId",
        "displayName": "Unique transaction reference",
        "simpleValueType": true
      },
      {
        "type": "TEXT",
        "name": "purchaseAmount",
        "displayName": "Purchase amount",
        "simpleValueType": true
      },
      {
        "type": "TEXT",
        "name": "currency",
        "displayName": "Currency",
        "simpleValueType": true
      },
      {
        "type": "TEXT",
        "name": "voucher",
        "displayName": "Voucher",
        "simpleValueType": true
      },
      {
        "type": "TEXT",
        "name": "newCustomer",
        "displayName": "New customer",
        "simpleValueType": true,
        "help": "1 for a new client, 0 otherwise"
      },
      {
        "type": "TEXT",
        "name": "consentPerformance",
        "displayName": "Consent",
        "simpleValueType": true,
        "help": "1 when the user consent that their data is used for performance analytics, 0 otherwise"
      },
      {
        "type": "TEXT",
        "name": "attrib",
        "displayName": "Attribution",
        "simpleValueType": true,
        "help": "1 when Effinity is the last touchpoint, 2 when Effinity intervened but isn't last, 0 if Effinity didn't intervene."
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "refParameters",
    "displayName": "Ref Parameters",
    "groupStyle": "ZIPPY_CLOSED",
    "subParams": [
      {
        "type": "SIMPLE_TABLE",
        "name": "refTable",
        "displayName": "Additional parameters",
        "simpleTableColumns": [
          {
            "defaultValue": "",
            "displayName": "ref",
            "name": "ref",
            "type": "SELECT",
            "selectItems": [
              {
                "value": "ref2",
                "displayValue": "ref2"
              },
              {
                "value": "ref3",
                "displayValue": "ref3"
              },
              {
                "value": "ref4",
                "displayValue": "ref4"
              },
              {
                "value": "ref5",
                "displayValue": "ref5"
              },
              {
                "value": "ref6",
                "displayValue": "ref6"
              },
              {
                "value": "ref7",
                "displayValue": "ref7"
              },
              {
                "value": "ref8",
                "displayValue": "ref8"
              },
              {
                "value": "ref9",
                "displayValue": "ref9"
              },
              {
                "value": "ref10",
                "displayValue": "ref10"
              },
              {
                "value": "ref11",
                "displayValue": "ref11"
              },
              {
                "value": "ref12",
                "displayValue": "ref12"
              },
              {
                "value": "ref13",
                "displayValue": "ref13"
              },
              {
                "value": "ref14",
                "displayValue": "ref14"
              },
              {
                "value": "ref15",
                "displayValue": "ref15"
              },
              {
                "value": "ref16",
                "displayValue": "ref16"
              },
              {
                "value": "ref17",
                "displayValue": "ref17"
              },
              {
                "value": "ref18",
                "displayValue": "ref18"
              },
              {
                "value": "ref19",
                "displayValue": "ref19"
              },
              {
                "value": "ref20",
                "displayValue": "ref20"
              }
            ]
          },
          {
            "defaultValue": "",
            "displayName": "value",
            "name": "value",
            "type": "TEXT"
          }
        ],
        "help": "",
        "valueValidators": []
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "advancedParameters",
    "displayName": "Advanced Parameters",
    "groupStyle": "ZIPPY_CLOSED",
    "subParams": [
      {
        "type": "TEXT",
        "name": "pageViewEvent",
        "displayName": "Page view event name",
        "simpleValueType": true,
        "defaultValue": "page_view"
      },
      {
        "type": "TEXT",
        "name": "purchaseEvent",
        "displayName": "Purchase event name",
        "simpleValueType": true,
        "defaultValue": "purchase"
      },
      {
        "type": "TEXT",
        "name": "leadEvent",
        "displayName": "Lead event name",
        "simpleValueType": true,
        "defaultValue": "generate_lead"
      },
      {
        "type": "TEXT",
        "name": "cookieExpiration",
        "displayName": "Cookie expiration in days",
        "simpleValueType": true,
        "defaultValue": 30,
        "valueValidators": [
          {
            "type": "POSITIVE_NUMBER"
          }
        ]
      }
    ]
  }
]


___SANDBOXED_JS_FOR_SERVER___

const sendHttpRequest = require('sendHttpRequest');
const getAllEventData = require('getAllEventData');
const setCookie = require('setCookie');
const getCookieValues = require('getCookieValues');
const parseUrl = require('parseUrl');
const encodeUriComponent = require('encodeUriComponent');

const eventModel = getAllEventData();

const PAGE_VIEW_EVENT = data.pageViewEvent;
const PURCHASE_EVENT = data.purchaseEvent;
const GENERATE_LEAD_EVENT = data.leadEvent;


function encodeUri(value) {
  value = value || '';
  return encodeUriComponent(value);
}

switch (eventModel.event_name) {
  case PAGE_VIEW_EVENT:
    const parsedUrl = parseUrl(eventModel.page_location);
    const params = {};

    if (parsedUrl && parsedUrl.searchParams) {
      for (let param in parsedUrl.searchParams) {
        if (param.toLowerCase() === 'eff_cpt') {
          params.editorId = parsedUrl.searchParams[param];
        }
        if (param.toLowerCase() === 'eff_sub1') {
          params.sub1 = parsedUrl.searchParams[param];
        }
        if (param.toLowerCase() === 'eff_sub2') {
          params.sub2 = parsedUrl.searchParams[param];
        }
        if (param.toLowerCase() === 'eff_pid') {
          params.productId = parsedUrl.searchParams[param];
        }
      }
    }

    if (params.editorId) {
      const value = [
        params.editorId,
        params.sub1,
        params.sub2,
        params.productId
      ].join(';');

      const options = {
        domain: 'auto',
        path: '/',
        secure: true,
        httpOnly: false,
        'max-age': 86400 * data.cookieExpiration
      };
      setCookie('effi', value, options, false);
    }

    data.gtmOnSuccess();
    break;
  case PURCHASE_EVENT:
  case GENERATE_LEAD_EVENT:
    const effiCookie = getCookieValues('effi');

    const cookieParams = effiCookie[0] ? effiCookie[0].split(';') : null;
    const editorId = cookieParams ? cookieParams[0] : null;
    const subId1 = cookieParams ? cookieParams[1] : null;
    const subId2 = cookieParams ? cookieParams[2] : null;
    const effiProductId = cookieParams ? cookieParams[3] : null;

    const urlParams = [
      'id=' + data.customerId,

      'id_compteur=' + editorId,
      subId1 ? 'effi_id=' + subId1 : '',
      subId2 ? 'effi_id2=' + subId2 : '',
      effiProductId ? 'prod_id=' + effiProductId : '',
      
      'ref=' + encodeUri(data.transactionId !== undefined ? data.transactionId : eventModel.transaction_id),
      data.consentPerformance !== undefined ? 'consent_performance=' + encodeUri(data.consentPerformance) : '',
    ];

    if (eventModel.event_name === PURCHASE_EVENT) {
      urlParams.push('montant=' + encodeUri(data.purchaseAmount ? data.purchaseAmount : eventModel.value));
      urlParams.push('monnaie=' + encodeUri(data.currency ? data.currency : eventModel.currency));
      urlParams.push(data.newCustomer !== undefined ? 'newcustomer=' + encodeUri(data.newCustomer) : '');
      urlParams.push(data.attribution !== undefined ? 'attrib=' + encodeUri(data.attribution) : '');
      urlParams.push(
        data.voucher !== undefined || eventModel.coupon !== undefined ?
          'voucher=' + encodeUri(data.voucher !== undefined ? data.voucher : eventModel.coupon) :
          ''
      );
    }

    const includedRef = [];
    for (let key in data.refTable) {
      const row = data.refTable[key];
      if (includedRef.indexOf(row.ref) !== -1) {
        continue;
      }

      if (row.value === undefined) {
        continue;
      }

      includedRef.push(row.ref);
      urlParams.push(row.ref + '=' + encodeUri(row.value));
    }

    const urlParamsString = urlParams.filter((v) => v).join('&');

    if (data.clearCookie) {
      setCookie('effi', '', {
        domain: 'auto',
        path: '/',
        secure: true,
        httpOnly: false,
        'max-age': 10
      }, false);
    }
    
    const path = eventModel.event_name === PURCHASE_EVENT ? 'effi.revenuemobile' : 'effi.leadmobile';

    const requestHeaders = { method: 'GET' };
    const url = 'https://track.effiliation.com/servlet/' + path + '?' + urlParamsString;
    sendHttpRequest(url, (statusCode, headers, body) => {
      if (statusCode >= 200 && statusCode < 300) {
        data.gtmOnSuccess();
      } else {
        data.gtmOnFailure();
      }
    }, requestHeaders, '');
    break;
  default:
    data.gtmOnSuccess();
    break;
}


___SERVER_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "read_event_data",
        "versionId": "1"
      },
      "param": [
        {
          "key": "eventDataAccess",
          "value": {
            "type": 1,
            "string": "any"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "send_http",
        "versionId": "1"
      },
      "param": [
        {
          "key": "allowedUrls",
          "value": {
            "type": 1,
            "string": "specific"
          }
        },
        {
          "key": "urls",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "https://track.effiliation.com/*"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "set_cookies",
        "versionId": "1"
      },
      "param": [
        {
          "key": "allowedCookies",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "name"
                  },
                  {
                    "type": 1,
                    "string": "domain"
                  },
                  {
                    "type": 1,
                    "string": "path"
                  },
                  {
                    "type": 1,
                    "string": "secure"
                  },
                  {
                    "type": 1,
                    "string": "session"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "effi"
                  },
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "/"
                  },
                  {
                    "type": 1,
                    "string": "secure"
                  },
                  {
                    "type": 1,
                    "string": "any"
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "get_cookies",
        "versionId": "1"
      },
      "param": [
        {
          "key": "cookieAccess",
          "value": {
            "type": 1,
            "string": "specific"
          }
        },
        {
          "key": "cookieNames",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "effi"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  }
]


___TESTS___

scenarios: []


___NOTES___

Created on 2/15/2022, 16:06:45

